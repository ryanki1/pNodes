<div class="dashboard-container" [class.background-disabled]="!backgroundEffectEnabled()">
  <!-- Header -->
  <div class="page-header" [class.mock-mode]="isMockMode()">
    <div class="background-toggle">
      <span class="toggle-label">Background</span>
      <nz-switch
        [(ngModel)]="backgroundEffectEnabled"
        nzCheckedChildren="ON"
        nzUnCheckedChildren="OFF">
      </nz-switch>
    </div>
    <h1><img src="/assets/images/xandeum.png" alt="Xandeum Logo" class="logo"> Xandeum pNode Analytics @if (isMockMode()) {<span class="mock-badge">TEST MODE</span>}</h1>
    <p>Real-time monitoring of the Xandeum pNode network</p>
    <div class="datetime-display">
      <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
      <span class="datetime-text">{{ currentDateTime() }}</span>
    </div>
  </div>

  <!-- Loading Spinner -->
  @if (loading()) {
    <div class="loading-container">
      <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
      <p>Loading pNode data...</p>
    </div>
  }

  <!-- Error Message -->
  @if (error()) {
    <nz-card class="error-card">
      <p>{{ error() }}</p>
      <button class="refresh" nz-button nzType="primary" (click)="refresh()">Retry</button>
    </nz-card>
  }

  <!-- Dashboard Content -->
  @if (!error()) {
    <div class="card-grid">

      <!-- Card 1: Network Overview -->
      <nz-card [nzTitle]="networkTitle" [nzExtra]="networkExtra" class="dashboard-card">
        <ng-template #networkTitle>
          <div class="card-title">
            <span nz-icon nzType="global" nzTheme="outline" class="icon"></span>
            <div>
              <div class="title">Network Overview</div>
              <div class="subtitle">Real-time statistics</div>
            </div>
          </div>
        </ng-template>

        <ng-template #networkExtra>
          <button class="refresh" nz-button nzType="text" nzShape="circle" (click)="refresh()" title="Refresh">
            <span nz-icon nzType="reload" nzTheme="outline"></span>
          </button>
        </ng-template>

        <div nz-row [nzGutter]="16" class="stats-row">
          <div nz-col [nzSpan]="8">
            <nz-statistic
              [nzValue]="totalCount()"
              nzTitle="Total Pods"
              [nzValueStyle]="{ color: '#1890ff' }">
            </nz-statistic>
          </div>
          <div nz-col [nzSpan]="8">
            <nz-statistic
              [nzValue]="getOnlineCount()"
              nzTitle="Online"
              [nzValueStyle]="{ color: '#52c41a' }">
            </nz-statistic>
          </div>
          <div nz-col [nzSpan]="8">
            <nz-statistic
              [nzValue]="formatBytes(getTotalStorage())"
              nzTitle="Total Storage"
              [nzValueStyle]="{ color: '#fa8c16' }">
            </nz-statistic>
          </div>
        </div>

        <div class="network-source-info">
          <nz-tag [nzColor]="'blue'">
            <span nz-icon nzType="borderless-table" nzTheme="outline"></span>
            Source: Single Node Entry Point
          </nz-tag>
          <nz-tag [nzColor]="'blue'">
            (173.212.220.65)
          </nz-tag>
          <button
            nz-button
            nzType="dashed"
            nzSize="small"
            [disabled]="true"
            nz-tooltip
            nzTooltipTitle="Feature coming soon - Add multiple pNode peers for comprehensive network view">
            <span nz-icon nzType="plus" nzTheme="outline"></span>
            Add More Peers for Network View
          </button>
        </div>
      </nz-card>

      <!-- Card 2: Node Statistics -->
      @if (nodeStats()) {
        <nz-card [nzTitle]="statsTitle" class="dashboard-card">
          <ng-template #statsTitle>
            <div class="card-title">
              <span nz-icon nzType="database" nzTheme="outline" class="icon"></span>
              <div>
                <div class="title">Node Statistics</div>
                <div class="subtitle">Connected Node: 173.212.220.65</div>
              </div>
            </div>
          </ng-template>

          <div class="stat-col">
            <div class="stat-row progress-bar">
              <span class="stat-label">CPU Usage</span>
              <span class="stat-value">{{ nodeStats()!.cpu_percent | number:'1.1-1' }}%</span>
            </div>
            <nz-progress
              [nzPercent]="nodeStats()!.cpu_percent"
              [nzShowInfo]="false"
              [nzStatus]="nodeStats()!.cpu_percent > 80 ? 'exception' : 'active'">
            </nz-progress>
          </div>

          <div class="stat-row">
            <span class="stat-label">RAM Used / Total</span>
            <span class="stat-value">{{ formatBytes(nodeStats()!.ram_used) }} / {{ formatBytes(nodeStats()!.ram_total) }}</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Uptime</span>
            <span class="stat-value">{{ formatUptime(nodeStats()!.uptime) }}</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Active Streams</span>
            <span class="stat-value">{{ nodeStats()!.active_streams }}</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Packets Sent</span>
            <span class="stat-value">{{ nodeStats()!.packets_sent | number }}</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Packets Received</span>
            <span class="stat-value">{{ nodeStats()!.packets_received | number }}</span>
          </div>

        </nz-card>
      }

      <!-- Card 3: Pod List -->
      <nz-tabs [nzAnimated]="false">
        <nz-tab [nzTitle]="tabCharts">
          <ng-template #tabCharts>
            <span nz-icon nzType="line-chart" nzTheme="outline" class="icon"></span>
            Charts
          </ng-template>

          <!-- Charts Grid -->
          <div class="charts-grid" style="margin-top: 16px;">
            <div nz-row [nzGutter]="[16, 16]">

              <!-- Chart 5: Barchart of Network Storage with Snapshot every 5 minutes -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24">
                <nz-card nzTitle="Network Activity Over Time" class="chart-card">
                  <div id="barChart" style="height: 300px;"></div>
                </nz-card>
              </div>

              <!-- Chart 1: Storage Distribution (Pie) -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12">
                <nz-card nzTitle="Storage Distribution" class="chart-card">
                  <div style="height: 300px; position: relative;">
                    @if (hasData(storageDistribution())) {
                      <ngx-charts-pie-chart
                        [results]="storageDistribution()"
                        [labels]="true"
                        [doughnut]="false">
                      </ngx-charts-pie-chart>
                    } @else {
                      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <div style="text-align: center;">
                          <span nz-icon nzType="pie-chart" nzTheme="outline" class="icon"></span> 
                          <div>No data available</div>
                        </div>
                      </div>
                    }
                  </div>
                </nz-card>
              </div>

              <!-- Chart 2: Version Distribution (Pie) -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12">
                <nz-card nzTitle="Version Distribution" class="chart-card">
                  <div style="height: 300px; position: relative;">
                    @if (hasData(versionDistribution())) {
                      <ngx-charts-pie-chart
                        [results]="versionDistribution()"
                        [labels]="true"
                        [doughnut]="true">
                      </ngx-charts-pie-chart>
                    } @else {
                      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <div style="text-align: center;">
                          <span nz-icon nzType="pie-chart" nzTheme="outline" class="icon"></span> 
                          <div>No data available</div>
                        </div>
                      </div>
                    }
                  </div>
                </nz-card>
              </div>

              <!-- Chart 3: Last Seen Distribution (Bar) -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12">
                <nz-card nzTitle="Last Seen Distribution" class="chart-card">
                  <div style="height: 300px; position: relative;">
                    @if (hasData(lastSeenDistribution())) {
                      <ngx-charts-bar-vertical
                        [results]="lastSeenDistribution()"
                        [xAxis]="true"
                        [yAxis]="true"
                        [legend]="false"
                        [showXAxisLabel]="true"
                        [showYAxisLabel]="true"
                        xAxisLabel="Time Range"
                        yAxisLabel="Number of Pods">
                      </ngx-charts-bar-vertical>
                    } @else {
                      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <div style="text-align: center;">
                          <span nz-icon nzType="bar-chart" nzTheme="outline" class="icon"></span> 
                          <div>No data available</div>
                        </div>
                      </div>
                    }
                  </div>
                </nz-card>
              </div>

              <!-- Chart 4: Uptime Health Distribution (Pie) -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12">
                <nz-card nzTitle="Uptime Health Distribution" class="chart-card">
                  <div style="height: 300px; position: relative;">
                    @if (hasData(uptimeHealthDistribution())) {
                      <ngx-charts-pie-chart
                        [results]="uptimeHealthDistribution()"
                        [labels]="true"
                        [doughnut]="true">
                      </ngx-charts-pie-chart>
                    } @else {
                      <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <div style="text-align: center;">
                          <span nz-icon nzType="pie-chart" nzTheme="outline" class="icon"></span> 
                          <div>No data available</div>
                        </div>
                      </div>
                    }
                  </div>
                </nz-card>
              </div>

            </div>
          </div>

        </nz-tab>
        <nz-tab [nzTitle]="tabPodList">
          <ng-template #tabPodList>
            <span nz-icon nzType="cluster" nzTheme="outline" class="icon"></span>
            Pods
          </ng-template>
          <nz-card [nzTitle]="podListTitle" [nzExtra]="podListExtra" class="dashboard-card pod-list-card">
            <ng-template #podListTitle>
              <div class="card-title">
                <span nz-icon nzType="database" nzTheme="outline" class="icon"></span>
                <div>
                  <div class="title">Active Pods</div>
                  <div class="subtitle">{{ totalCount() }} pods in network</div>
                </div>
              </div>
            </ng-template>

            <ng-template #podListExtra>
              <div style="display: flex; align-items: center; gap: 8px;">
                <nz-tag [nzColor]="'blue'">{{ totalCount() }} Total</nz-tag>
                <button class="refresh" nz-button nzType="text" nzShape="circle" (click)="refresh()" title="Refresh">
                  <span nz-icon nzType="reload" nzTheme="outline"></span>
                </button>
              </div>
            </ng-template>

            <nz-table
              #podTable
              [nzData]="tableData()"
              [nzPageSize]="10"
              [nzScroll]="{ x: '600px' }"
              nzSize="small">
              <thead>
                <tr>
                  <th nzWidth="180px"
                      nzShowSort
                      [nzSortFn]="sortByPubkey">
                    Public Key
                  </th>
                  <th nzWidth="150px"
                      nzShowSort
                      [nzSortFn]="sortByAddress">
                    Address
                  </th>
                  <th nzWidth="100px"
                      nzShowSort
                      [nzSortFn]="sortByStorage"
                      [nzFilterMultiple]="false"
                      [nzFilters]="storageFilters"
                      [nzFilterFn]="filterByStorage">
                    Storage
                  </th>
                  <th nzWidth="100px"
                      nzShowSort
                      [nzSortFn]="sortByStoragePercent"
                      [nzFilterMultiple]="false"
                      [nzFilters]="storagePercentFilters"
                      [nzFilterFn]="filterByStoragePercent">
                    % Used
                  </th>
                  <th nzWidth="100px"
                      nzShowSort
                      [nzSortFn]="sortByUptime"
                      [nzFilterMultiple]="false"
                      [nzFilters]="uptimeFilters"
                      [nzFilterFn]="filterByUptime">
                    Uptime
                  </th>
                  <th nzWidth="80px"
                      nzShowSort
                      [nzSortFn]="sortByVersion">
                    Version
                  </th>
                </tr>
              </thead>
              <tbody>
                @for (pod of podTable.data; track pod.pubkey) {
                  <tr>
                    <td>
                      <code class="pubkey">{{ shortenPubkey(pod.pubkey || '') }}</code>
                    </td>
                    <td>
                      <small>{{ pod.address || 'N/A' }}</small>
                    </td>
                    <td>
                      <strong>{{ formatBytes(pod.storage_used || 0) }}</strong>
                    </td>
                    <td>
                      <strong>{{ ((pod.storage_usage_percent || 0) * 100).toFixed(1) }}%</strong>
                    </td>
                    <td>
                      {{ formatUptime(pod.uptime || 0) }}
                    </td>
                    <td>
                      <nz-tag [nzColor]="'green'">{{ pod.version || 'N/A' }}</nz-tag>
                    </td>
                  </tr>
                }
              </tbody>
            </nz-table>
          </nz-card>
        </nz-tab>
      </nz-tabs>
    </div>
  }
</div>
