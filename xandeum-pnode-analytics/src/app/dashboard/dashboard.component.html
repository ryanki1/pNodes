<div class="dashboard-container">
  <!-- Header -->
  <div class="page-header" [class.mock-mode]="isMockMode()">
    <h1>üî∑ Xandeum pNode Analytics @if (isMockMode()) {<span class="mock-badge">TEST MODE</span>}</h1>
    <p>Real-time monitoring of the Xandeum pNode network</p>
  </div>

  <!-- Loading Spinner -->
  @if (loading()) {
    <div class="loading-container">
      <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
      <p>Loading pNode data...</p>
    </div>
  }

  <!-- Error Message -->
  @if (error()) {
    <nz-card class="error-card">
      <p>{{ error() }}</p>
      <button nz-button nzType="primary" (click)="refresh()">Retry</button>
    </nz-card>
  }

  <!-- Dashboard Content -->
  @if (!error()) {
    <div class="card-grid">

      <!-- Card 1: Network Overview -->
      <nz-card [nzTitle]="networkTitle" [nzExtra]="networkExtra" class="dashboard-card">
        <ng-template #networkTitle>
          <div class="card-title">
            <span class="icon">üåê</span>
            <div>
              <div class="title">Network Overview</div>
              <div class="subtitle">Real-time statistics</div>
            </div>
          </div>
        </ng-template>

        <ng-template #networkExtra>
          <button nz-button nzType="text" nzShape="circle" (click)="refresh()" title="Refresh">
            <span nz-icon nzType="reload" nzTheme="outline"></span>
          </button>
        </ng-template>

        <div nz-row [nzGutter]="16" class="stats-row">
          <div nz-col [nzSpan]="8">
            <nz-statistic
              [nzValue]="totalCount()"
              nzTitle="Total Pods"
              [nzValueStyle]="{ color: '#1890ff' }">
            </nz-statistic>
          </div>
          <div nz-col [nzSpan]="8">
            <nz-statistic
              [nzValue]="getOnlineCount()"
              nzTitle="Online"
              [nzValueStyle]="{ color: '#52c41a' }">
            </nz-statistic>
          </div>
          <div nz-col [nzSpan]="8">
            <nz-statistic
              [nzValue]="formatBytes(getTotalStorage())"
              nzTitle="Total Storage"
              [nzValueStyle]="{ color: '#fa8c16' }">
            </nz-statistic>
          </div>
        </div>
      </nz-card>

      <!-- Card 2: Node Statistics -->
      @if (nodeStats()) {
        <nz-card [nzTitle]="statsTitle" class="dashboard-card">
          <ng-template #statsTitle>
            <div class="card-title">
              <span class="icon">üìä</span>
              <div>
                <div class="title">Node Statistics</div>
                <div class="subtitle">Connected Node: 173.212.220.65</div>
              </div>
            </div>
          </ng-template>

          <div class="stat-col">
            <div class="stat-row progress-bar">
              <span class="stat-label">CPU Usage</span>
              <span class="stat-value">{{ nodeStats()!.cpu_percent | number:'1.1-1' }}%</span>
            </div>
            <nz-progress
              [nzPercent]="nodeStats()!.cpu_percent"
              [nzShowInfo]="false"
              [nzStatus]="nodeStats()!.cpu_percent > 80 ? 'exception' : 'active'">
            </nz-progress>
          </div>

          <div class="stat-row">
            <span class="stat-label">RAM Used / Total</span>
            <span class="stat-value">{{ formatBytes(nodeStats()!.ram_used) }} / {{ formatBytes(nodeStats()!.ram_total) }}</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Uptime</span>
            <span class="stat-value">{{ formatUptime(nodeStats()!.uptime) }}</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Active Streams</span>
            <span class="stat-value">{{ nodeStats()!.active_streams }}</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Packets Sent</span>
            <span class="stat-value">{{ nodeStats()!.packets_sent | number }}</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">Packets Received</span>
            <span class="stat-value">{{ nodeStats()!.packets_received | number }}</span>
          </div>

        </nz-card>
      }

      <!-- Card 3: Pod List -->
      <nz-tabs [nzAnimated]="false">
        <nz-tab [nzTitle]="tabCharts">
          <ng-template #tabCharts>
            <span class="icon">üìà</span>
            Charts
          </ng-template>

          <!-- Charts Grid -->
          <div class="charts-grid" style="margin-top: 16px;">
            <div nz-row [nzGutter]="[16, 16]">

              <!-- Chart 5: Barchart of Network Storage with Snapshot every 5 minutes -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24">
                <div class="chart-card">
                  <div id="barChart" style="height: 300px;"></div>
                </div>
              </div>

              <!-- Chart 1: Storage Distribution (Pie) -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12">
                <nz-card nzTitle="Storage Distribution" class="chart-card">
                  <div style="height: 300px;">
                    <ngx-charts-pie-chart
                      [results]="storageDistribution()"
                      [labels]="true"
                      [doughnut]="true">
                    </ngx-charts-pie-chart>
                  </div>
                </nz-card>
              </div>

              <!-- Chart 2: Version Distribution (Pie) -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12">
                <nz-card nzTitle="Version Distribution" class="chart-card">
                  <div style="height: 300px;">
                    <ngx-charts-pie-chart
                      [results]="versionDistribution()"
                      [labels]="true"
                      [doughnut]="false">
                    </ngx-charts-pie-chart>
                  </div>
                </nz-card>
              </div>

              <!-- Chart 3: Last Seen Distribution (Bar) -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12">
                <nz-card nzTitle="Last Seen Distribution" class="chart-card">
                  <div style="height: 300px;">
                    <ngx-charts-bar-vertical
                      [results]="lastSeenDistribution()"
                      [xAxis]="true"
                      [yAxis]="true"
                      [legend]="false"
                      [showXAxisLabel]="true"
                      [showYAxisLabel]="true"
                      xAxisLabel="Time Range"
                      yAxisLabel="Number of Pods">
                    </ngx-charts-bar-vertical>
                  </div>
                </nz-card>
              </div>

              <!-- Chart 4: Uptime Health Distribution (Pie) -->
              <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12" [nzLg]="12">
                <nz-card nzTitle="Uptime Health Distribution" class="chart-card">
                  <div style="height: 300px;">
                    <ngx-charts-pie-chart
                      [results]="uptimeHealthDistribution()"
                      [labels]="true"
                      [doughnut]="false">
                    </ngx-charts-pie-chart>
                  </div>
                </nz-card>
              </div>

            </div>
          </div>

        </nz-tab>
        <nz-tab [nzTitle]="tabPodList">
          <ng-template #tabPodList>
            <span class="icon">üì¶</span>
            Pods
          </ng-template>
          <nz-card [nzTitle]="podListTitle" [nzExtra]="podListExtra" class="dashboard-card pod-list-card">
            <ng-template #podListTitle>
              <div class="card-title">
                <span class="icon">üì¶</span>
                <div>
                  <div class="title">Active Pods</div>
                  <div class="subtitle">{{ totalCount() }} pods in network</div>
                </div>
              </div>
            </ng-template>

            <ng-template #podListExtra>
              <nz-tag [nzColor]="'blue'">{{ totalCount() }} Total</nz-tag>
            </ng-template>

            <nz-table
              #podTable
              [nzData]="pods()"
              [nzPageSize]="10"
              [nzScroll]="{ x: '600px' }"
              nzSize="small">
              <thead>
                <tr>
                  <th nzWidth="180px">Public Key</th>
                  <th nzWidth="150px">Address</th>
                  <th nzWidth="100px">Storage</th>
                  <th nzWidth="100px">Uptime</th>
                  <th nzWidth="80px">Version</th>
                </tr>
              </thead>
              <tbody>
                @for (pod of podTable.data; track pod.pubkey) {
                  <tr>
                    <td>
                      <code class="pubkey">{{ shortenPubkey(pod.pubkey || '') }}</code>
                    </td>
                    <td>
                      <small>{{ pod.address || 'N/A' }}</small>
                    </td>
                    <td>
                      <strong>{{ formatBytes(pod.storage_used || 0) }}</strong>
                    </td>
                    <td>
                      {{ formatUptime(pod.uptime || 0) }}
                    </td>
                    <td>
                      <nz-tag [nzColor]="'green'">{{ pod.version || 'N/A' }}</nz-tag>
                    </td>
                  </tr>
                }
              </tbody>
            </nz-table>
          </nz-card>
        </nz-tab>
      </nz-tabs>
    </div>
  }
</div>
